name: CodeQL Security Scan

permissions: {}

on:
    push:
        branches:
            - "**"
    pull_request:
        branches: [main]
    schedule:
        - cron: "0 3 * * 1" # weekly on Monday
    workflow_dispatch:

jobs:
    analyze:
        name: Analyze (${{ matrix.language }}/${{ matrix.query_suite }})
        runs-on: ubuntu-latest

        permissions:
            security-events: write
            packages: read
            actions: read
            contents: read

        strategy:
            fail-fast: false
            matrix:
                language: ["go"]
                query_suite: ["security-and-quality", "security-extended"]

        steps:
            - name: Checkout code
              uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

            - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
              with:
                  go-version-file: go.mod
                  cache-dependency-path: .github/go.mod

            - name: Initialize CodeQL
              uses: github/codeql-action/init@f443b600d91635bebf5b0d9ebc620189c0d6fba5 # v4.30.8
              with:
                  languages: ${{ matrix.language }}
                  queries: ${{ matrix.query_suite }}
                  build-mode: manual

            - name: Set protoc path
              id: protoc_path
              run: echo "path=$HOME/.local" >> $GITHUB_OUTPUT

            - name: Cache protoc
              id: cache-protoc
              uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
              with:
                  path: ${{ steps.protoc_path.outputs.path }}
                  key: ${{ runner.os }}-protoc-3.20.1

            - name: Install protoc
              if: steps.cache-protoc.outputs.cache-hit != 'true'
              run: |
                  PB_VERSION="3.20.1"
                  PB_REL="https://github.com/protocolbuffers/protobuf/releases"
                  curl -LO $PB_REL/download/v$PB_VERSION/protoc-$PB_VERSION-linux-x86_64.zip
                  unzip -n protoc-$PB_VERSION-linux-x86_64.zip -d ${{ steps.protoc_path.outputs.path }}
                  rm protoc-$PB_VERSION-linux-x86_64.zip

            - name: Add protoc to path
              run: echo "${{ steps.protoc_path.outputs.path }}/bin" >> $GITHUB_PATH

            - name: Build
              run: |
                  cd .github && go mod download && cd ..
                  go run github.com/magefile/mage build:binaries

            - name: Analyze
              uses: github/codeql-action/analyze@f443b600d91635bebf5b0d9ebc620189c0d6fba5 # v4.30.8
              with:
                  category: "/language:${{ matrix.language }}/${{ matrix.query_suite }}"

            - name: Summary
              run: echo "CodeQL scan done for ${{ matrix.language }}/${{ matrix.query_suite }}"
